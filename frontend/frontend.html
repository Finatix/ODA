<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Data Platform Chat</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Custom CSS for pastel blue tones */
        body {
          background-color: #f0f8ff; /* Light pastel blue */
        }
        .chat-container {
          max-width: 500px;
          margin: auto;
        }
        .chat-box {
          border-radius: 10px;
          margin-bottom: 20px;
        }
        .user-message {
          background-color: #add8e6; /* Light pastel blue for user input */
        }
        .ai-message {
          background-color: #bfe5ff; /* Slightly darker pastel blue for AI response */
        }
        .message {
          padding: 10px;
          margin: 5px;
          border-radius: 10px;
        }
        .user-message .message {
          background-color: #add8e6; /* Light pastel blue for user input */
          color: #000; /* Black text */
        }
        .ai-message .message {
          background-color: #bfe5ff; /* Slightly darker pastel blue for AI response */
          color: #000; /* Black text */
        }
    </style>
</head>
<body>
<div class="container mt-5 chat-container">
    <div class="row">
        <div class="col-md-12">
            <!-- Chat Interface -->
            <div class="chat-box">
                <h5 class="text-primary">Chat</h5>
                <div id="chat-messages">
                </div>
                <div class="input-group mt-3">
                    <input type="text" class="form-control" placeholder="Type your message..."
                           aria-label="Type your message" aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="button">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- JavaScript for Chat -->
<script>

    async function fetchDataFromAPI(url, options) {
  try {
  const response = await fetch(url, options);
  const result = await response.json();
  //console.log(result.conversationToken);
  //console.log(response.json());
      } catch (error) {
  console.error(error);
  }
  }

  postConversationsURL = 'https://raw.githubusercontent.com/api/conversations'
  postConversationsOptions = {
  method: 'POST'/*,
  headers: {
      'content-type': 'application/x-www-form-urlencoded',
      'Accept-Encoding': 'application/gzip',
      'X-RapidAPI-Key': '2a628a2aa7msh21b2b2ef151e50bp1d9caejsn507946985984',

  }*/
  }

	/* get whole messages list to append it to the chat body */
  async function getMessages (conversationToken) {
  getMessagesURL = `https://raw.githubusercontent.com/api/conversations/${conversationToken}/messages`
  getMessagesOptions = {
  method: 'GET',
  headers: {
      'conversationToken': conversationToken
  }
  }
  result = fetchDataFromAPI(getMessagesURL, getMessagesOptions);
  return result;
}

  // if we don't have conversationToken, make a post and retrieve it. Also when we do have it already, load the list of messages.
   conversationToken = localStorage.getItem('conversationToken');
  if (conversationToken===null)
  {
      //result = fetchDataFromAPI(postConversationsURL, postConversationsOptions);
      //conversationToken = result.conversationToken;
	  conversationToken = "3fa85f64-5717-4562-b3fc-2c963f66afa6"; //only for test
      localStorage.setItem('conversationToken', conversationToken)
      console.log(conversationToken); // only for test
  }
  else {
      //messages = getMessages(conversationToken);
      // Function to display messages in the chat interface
	  
	  /* for testing purposes only */
	  const messages = [
  {
    id: "1",
    sender: "user",
    timestamp: "2024-04-14T10:00:00",
    conversation: "123456",
    text: "Hello, how can I help you?"
  },
  {
    id: "2",
    sender: "AI",
    timestamp: "2024-04-14T10:01:00",
    conversation: "123456",
    text: "Hello! I'm here to assist you."
  },
  // Add more messages here...
];
	var chatContainer = document.getElementById('chat-container');
  var chatMessages = document.getElementById('chat-messages');
  messages.forEach(message => {
  const messageElement = document.createElement('div');
  messageElement.textContent = `${message.sender}: ${message.text}`;
  // Add CSS class based on the sender
  if (message.sender === 'user') {
    messageElement.classList.add('message', 'user-message');
  } else if (message.sender === 'AI') {
    messageElement.classList.add('message', 'ai-message');
  }
  chatMessages.appendChild(messageElement);
});
}


  async function postMessage (conversationToken,message) {
  postConversationsMessagesURL = `https://raw.githubusercontent.com/api/conversations/${conversationToken}/messages`
  postConversationsMessagesOptions = {
  method: 'POST',
  headers: {
      'content-type': 'application/json',
      'conversationToken': conversationToken,
      'message': message
  }
  }
  result = fetchDataFromAPI(postConversationsMessagesURL, postConversationsMessagesOptions);
  return(result);
}



  // Function to send message
  function sendMessage(conversationToken) {
    var messageInput = document.querySelector('.chat-box input[type="text"]');
    var message = messageInput.value;
    var chatMessages = document.getElementById('chat-messages');
    var newMessage = document.createElement('div');
    newMessage.className = 'message user-message'; // User message
    newMessage.textContent = message;
    chatMessages.appendChild(newMessage);
    messageInput.value = ''; // Clear input field after sending message

    // Simulate AI response (replace with actual AI response)
    var aiResponseDiv = document.createElement('div');
    aiResponseDiv.className = 'message ai-message'; // AI message
	console.log(conversationToken);
    aiResponse = postMessage(conversationToken, message)
    aiResponseDiv.textContent = aiResponse;
    chatMessages.appendChild(aiResponseDiv);
  }

  // Event listener for send button click
  document.querySelector('.chat-box button').addEventListener('click', function() {
    sendMessage(conversationToken);
  });

  // Event listener for Enter key press
  document.querySelector('.chat-box input[type="text"]').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
</script>


</body>
</html>
